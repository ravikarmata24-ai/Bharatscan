{% extends "base.html" %}
{% block title %}Scan Product - BharatScan{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="text-center mb-4">
                <i class="bi bi-upc-scan"></i> Scan Product Barcode
            </h2>

            <!-- Scan Method Tabs -->
            <ul class="nav nav-pills nav-justified mb-4" id="scanTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="camera-tab" data-bs-toggle="pill" 
                            data-bs-target="#camera-scan" type="button">
                        <i class="bi bi-camera-fill"></i> Camera
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upload-tab" data-bs-toggle="pill" 
                            data-bs-target="#upload-scan" type="button">
                        <i class="bi bi-upload"></i> Upload Image
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-tab" data-bs-toggle="pill" 
                            data-bs-target="#manual-scan" type="button">
                        <i class="bi bi-keyboard"></i> Manual Entry
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="scanTabContent">
                
                <!-- ========== CAMERA SCAN TAB ========== -->
                <div class="tab-pane fade show active" id="camera-scan" role="tabpanel">
                    <div class="card shadow-sm border-0">
                        <div class="card-body text-center p-4">
                            <div id="camera-container" class="position-relative mb-3">
                                <video id="camera-feed" class="w-100 rounded" autoplay playsinline 
                                       style="max-height: 400px; background: #000;"></video>
                                <div class="scan-overlay">
                                    <div class="scan-guide"></div>
                                </div>
                                <canvas id="camera-canvas" style="display:none;"></canvas>
                            </div>
                            
                            <div id="camera-status" class="mb-3">
                                <p class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    Click "Start Camera" and position the barcode within the scanning area
                                </p>
                            </div>
                            
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <button id="startCameraBtn" class="btn btn-india" onclick="startCamera()">
                                    <i class="bi bi-camera-fill"></i> Start Camera
                                </button>
                                <button id="captureBtn" class="btn btn-success" onclick="captureFrame()" 
                                        style="display:none;">
                                    <i class="bi bi-camera"></i> Capture & Scan
                                </button>
                                <button id="stopCameraBtn" class="btn btn-danger" onclick="stopCamera()" 
                                        style="display:none;">
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb"></i> 
                                    <strong>Tips:</strong> Hold steady, ensure good lighting, 
                                    and keep barcode within the orange guide box.
                                    Auto-scan runs every 1.5 seconds.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== UPLOAD IMAGE TAB ========== -->
                <div class="tab-pane fade" id="upload-scan" role="tabpanel">
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="upload-zone text-center p-5 border-2 border-dashed rounded mb-3"
                                     id="dropZone">
                                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                                    <p class="mt-3 mb-1 fw-medium">Drag & drop a barcode image here</p>
                                    <p class="text-muted small">or click to browse files</p>
                                    <input type="file" id="imageInput" name="image" 
                                           accept="image/*" class="d-none">
                                    <button type="button" class="btn btn-outline-india mt-2" 
                                            onclick="document.getElementById('imageInput').click()">
                                        <i class="bi bi-image"></i> Choose Image
                                    </button>
                                    <p class="text-muted small mt-2 mb-0">
                                        Supports: PNG, JPG, JPEG, GIF, BMP, WebP (Max 16MB)
                                    </p>
                                </div>
                                
                                <!-- Image Preview -->
                                <div id="imagePreview" class="text-center mb-3" style="display:none;">
                                    <img id="previewImg" class="img-fluid rounded shadow-sm" 
                                         style="max-height: 300px;">
                                    <br>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                                            onclick="clearUpload()">
                                        <i class="bi bi-x-circle"></i> Remove Image
                                    </button>
                                </div>

                                <button type="submit" class="btn btn-india w-100 btn-lg" id="uploadBtn">
                                    <i class="bi bi-search"></i> Scan Barcode from Image
                                </button>
                            </form>

                            <!-- Upload Result -->
                            <div id="uploadResult" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <!-- ========== MANUAL ENTRY TAB ========== -->
                <div class="tab-pane fade" id="manual-scan" role="tabpanel">
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <form id="manualForm">
                                <div class="mb-3">
                                    <label for="manualBarcode" class="form-label fw-medium">
                                        <i class="bi bi-upc"></i> Enter Barcode Number
                                    </label>
                                    <input type="text" id="manualBarcode" class="form-control form-control-lg" 
                                           placeholder="e.g., 8901058851854"
                                           maxlength="50" autofocus
                                           pattern="[A-Za-z0-9\-\.]*">
                                    <div class="form-text">
                                        Enter the barcode number printed on the product packaging.
                                        Usually 8 or 13 digits for Indian products starting with 890.
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-india w-100 btn-lg" id="manualSearchBtn">
                                    <i class="bi bi-search"></i> Search Product
                                </button>
                            </form>

                            <!-- Manual Result -->
                            <div id="manualResult" style="display:none;"></div>

                            <!-- Quick Links -->
                            <div class="mt-4">
                                <h6 class="text-muted"><i class="bi bi-lightning-fill"></i> Quick Try:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-sm btn-outline-secondary quick-barcode" 
                                            data-barcode="8901058851854">
                                        Parle-G
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary quick-barcode" 
                                            data-barcode="8901262150255">
                                        Maggi
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary quick-barcode" 
                                            data-barcode="8901790753456">
                                        Crocin
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary quick-barcode" 
                                            data-barcode="8901689152012">
                                        Himalaya Ashvagandha
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary quick-barcode" 
                                            data-barcode="8906009540115">
                                        Mamaearth Face Wash
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary quick-barcode" 
                                            data-barcode="8901790789456">
                                        Azithral 500
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary quick-barcode" 
                                            data-barcode="8904245700577">
                                        Biotique Shampoo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Supported Barcodes Info -->
            <div class="card mt-4 border-0 shadow-sm">
                <div class="card-body p-3">
                    <h6 class="text-center mb-3">
                        <i class="bi bi-check2-circle"></i> Supported Barcode Formats
                    </h6>
                    <div class="d-flex justify-content-center flex-wrap gap-2">
                        <span class="badge bg-light text-dark border">EAN-13</span>
                        <span class="badge bg-light text-dark border">EAN-8</span>
                        <span class="badge bg-light text-dark border">UPC-A</span>
                        <span class="badge bg-light text-dark border">UPC-E</span>
                        <span class="badge bg-light text-dark border">Code 128</span>
                        <span class="badge bg-light text-dark border">Code 39</span>
                        <span class="badge bg-light text-dark border">QR Code</span>
                        <span class="badge bg-light text-dark border">Data Matrix</span>
                    </div>
                    <p class="text-center text-muted small mt-2 mb-0">
                        ðŸ‡®ðŸ‡³ Indian products use EAN-13 barcodes starting with <strong>890</strong> (GS1 India)
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/scanner.js') }}"></script>
<script>
// Quick barcode buttons
document.querySelectorAll('.quick-barcode').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var barcode = this.getAttribute('data-barcode');
        window.location.href = '/result/' + barcode;
    });
});
</script>
{% endblock %}