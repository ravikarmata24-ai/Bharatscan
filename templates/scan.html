{% extends "base.html" %}

{% block title %}Scan Product - BharatScan{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="text-center mb-4">
                <h2>üîç Scan Product Barcode</h2>
                <p class="text-muted">Scan, upload, or enter barcode manually</p>
            </div>

            <ul class="nav nav-tabs nav-fill mb-4" id="scanTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="camera-tab" data-bs-toggle="tab" 
                            data-bs-target="#camera-panel" type="button" role="tab">üì∑ Camera</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" 
                            data-bs-target="#upload-panel" type="button" role="tab">üì§ Upload</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-tab" data-bs-toggle="tab" 
                            data-bs-target="#manual-panel" type="button" role="tab">‚å®Ô∏è Manual</button>
                </li>
            </ul>

            <div class="tab-content" id="scanTabContent">
                
                <!-- CAMERA TAB -->
                <div class="tab-pane fade show active" id="camera-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center p-2">
                            
                            <div id="reader" style="width: 100%; max-width: 600px; margin: 0 auto;"></div>
                            
                            <div id="camera-status" class="mt-2">
                                <span class="text-muted">Tap Start Camera to begin</span>
                            </div>

                            <div id="scan-success" class="alert alert-success mt-2" style="display: none;">
                                <strong>‚úÖ Barcode Detected!</strong><br>
                                <span id="detected-barcode" class="fs-4 fw-bold"></span><br>
                                <span class="text-muted">Redirecting...</span>
                            </div>

                            <div id="scan-error" class="alert alert-danger mt-2" style="display: none;"></div>
                            
                            <div class="mt-2">
                                <button id="btn-start" class="btn btn-success btn-lg me-2" onclick="startScanner()">‚ñ∂Ô∏è Start Camera</button>
                                <button id="btn-stop" class="btn btn-danger btn-lg" onclick="stopScanner()" style="display: none;">‚èπÔ∏è Stop</button>
                            </div>

                            <div class="mt-2 p-2 bg-light rounded">
                                <small class="text-muted">
                                    üì± Hold barcode steady for 3-5 seconds. Good lighting helps.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UPLOAD TAB -->
                <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <h5 class="mb-3">üì§ Upload Barcode Image</h5>
                            
                            <label class="btn btn-primary btn-lg w-100 py-3" for="gallery-upload">
                                üñºÔ∏è Choose Photo from Gallery
                            </label>
                            <input type="file" id="gallery-upload" class="d-none" 
                                   accept="image/*" 
                                   onchange="handleUpload(event)">
                            
                            <div id="upload-preview" class="mb-3 mt-3" style="display: none;">
                                <img id="preview-image" src="" alt="Preview" 
                                     style="max-width: 100%; max-height: 250px; border-radius: 8px;">
                            </div>

                            <div id="upload-status" class="mt-3" style="display: none;"></div>
                            <div id="upload-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- MANUAL TAB -->
                <div class="tab-pane fade" id="manual-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="text-center mb-3">‚å®Ô∏è Enter Barcode Number</h5>
                            
                            <div class="input-group input-group-lg mb-3">
                                <input type="text" id="manual-barcode" class="form-control" 
                                       placeholder="e.g., 8901058851854" 
                                       maxlength="13" inputmode="numeric"
                                       onkeypress="if(event.key === 'Enter') lookupManualBarcode();">
                                <button class="btn btn-primary" onclick="lookupManualBarcode()">üîç Search</button>
                            </div>

                            <div id="manual-result" class="mt-3" style="display: none;"></div>

                            <div class="mt-4">
                                <h6>üß™ Sample Barcodes:</h6>
                                <div class="row g-2 mt-2">
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901058851854')">Parle-G Gold</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901262150255')">Maggi Noodles</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901790753456')">Crocin 500mg</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901689152012')">Himalaya Ashvagandha</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901030697289')">Lakme SPF 50</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901030718960')">Dove Shampoo</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="quagga-upload-target" style="display: none;"></div>
<div id="h5qr-temp" style="display: none;"></div>
<canvas id="work-canvas" style="display: none;"></canvas>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode for CAMERA (proven working on iPhone Safari) -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- QuaggaJS for IMAGE upload scanning (better at finding barcodes in photos) -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

<script>
    var html5QrCode = null;
    var isScanning = false;

    // ============================================================
    // CAMERA ‚Äî html5-qrcode (proven working on iPhone 14 Safari)
    // ============================================================
    function startScanner() {
        var statusDiv = document.getElementById('camera-status');
        var successDiv = document.getElementById('scan-success');
        var errorDiv = document.getElementById('scan-error');

        successDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> Starting camera...';

        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'inline-block';

        html5QrCode = new Html5Qrcode("reader");

        var config = {
            fps: 10,
            qrbox: function(viewfinderWidth, viewfinderHeight) {
                var w = Math.floor(viewfinderWidth * 0.85);
                var h = Math.floor(w * 0.4);
                return { width: w, height: h };
            },
            formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.QR_CODE
            ],
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: false
            }
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onCameraSuccess,
            function() {}
        ).then(function() {
            isScanning = true;
            statusDiv.innerHTML = 'üü¢ <span class="text-success">Camera active ‚Äî point at barcode, hold steady</span>';
        }).catch(function(err) {
            html5QrCode.start(
                { facingMode: "user" },
                config,
                onCameraSuccess,
                function() {}
            ).then(function() {
                isScanning = true;
                statusDiv.innerHTML = 'üü¢ Camera active (front)';
            }).catch(function(err2) {
                errorDiv.innerHTML = '‚ùå Camera error. Allow permission and retry.<br>' +
                    '<button class="btn btn-primary btn-sm mt-2" onclick="startScanner()">üîÑ Retry</button>';
                errorDiv.style.display = 'block';
                statusDiv.style.display = 'none';
                document.getElementById('btn-start').style.display = 'inline-block';
                document.getElementById('btn-stop').style.display = 'none';
            });
        });
    }

    function onCameraSuccess(decodedText, decodedResult) {
        stopScanner();

        document.getElementById('detected-barcode').textContent = decodedText;
        document.getElementById('scan-success').style.display = 'block';
        document.getElementById('camera-status').style.display = 'none';

        playBeep();

        setTimeout(function() {
            window.location.href = '/result/' + encodeURIComponent(decodedText);
        }, 800);
    }

    function stopScanner() {
        if (html5QrCode && isScanning) {
            html5QrCode.stop().then(function() {
                isScanning = false;
                document.getElementById('camera-status').innerHTML = '‚è∏Ô∏è Stopped';
                document.getElementById('btn-start').style.display = 'inline-block';
                document.getElementById('btn-stop').style.display = 'none';
            }).catch(function() { isScanning = false; });
        }
    }

    // ============================================================
    // UPLOAD ‚Äî 4 methods: QuaggaJS, html5-qrcode, Server, Enhanced
    // ============================================================
    function handleUpload(event) {
        var file = event.target.files[0];
        if (!file) return;

        var previewImg = document.getElementById('preview-image');
        var statusDiv = document.getElementById('upload-status');
        var resultDiv = document.getElementById('upload-result');

        previewImg.src = URL.createObjectURL(file);
        document.getElementById('upload-preview').style.display = 'block';

        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <strong>Scanning barcode (Method 1 of 4)...</strong>';
        statusDiv.className = 'mt-3 alert alert-info';
        statusDiv.style.display = 'block';
        resultDiv.style.display = 'none';

        // Method 1: QuaggaJS decodeSingle (best for barcodes in photos)
        tryQuaggaScan(file, statusDiv, resultDiv);
    }

    // Method 1: QuaggaJS ‚Äî specifically designed for barcode detection in images
    function tryQuaggaScan(file, statusDiv, resultDiv) {
        var reader = new FileReader();
        reader.onload = function(e) {
            Quagga.decodeSingle({
                src: e.target.result,
                numOfWorkers: 0,
                inputStream: {
                    size: 1920
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "code_128_reader",
                        "code_39_reader"
                    ]
                },
                locate: true
            }, function(result) {
                if (result && result.codeResult && result.codeResult.code) {
                    showUploadSuccess(result.codeResult.code, statusDiv, resultDiv);
                } else {
                    // Try with different settings
                    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <strong>Method 2 of 4...</strong>';
                    tryQuaggaLarge(file, statusDiv, resultDiv);
                }
            });
        };
        reader.readAsDataURL(file);
    }

    // Method 2: QuaggaJS with larger scan area
    function tryQuaggaLarge(file, statusDiv, resultDiv) {
        var reader = new FileReader();
        reader.onload = function(e) {
            Quagga.decodeSingle({
                src: e.target.result,
                numOfWorkers: 0,
                inputStream: {
                    size: 2560
                },
                locator: {
                    patchSize: "large",
                    halfSample: false
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "code_128_reader"
                    ]
                },
                locate: true
            }, function(result) {
                if (result && result.codeResult && result.codeResult.code) {
                    showUploadSuccess(result.codeResult.code, statusDiv, resultDiv);
                } else {
                    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <strong>Method 3 of 4...</strong>';
                    tryHtml5QrCodeScan(file, statusDiv, resultDiv);
                }
            });
        };
        reader.readAsDataURL(file);
    }

    // Method 3: html5-qrcode scanFile
    function tryHtml5QrCodeScan(file, statusDiv, resultDiv) {
        var scanner = new Html5Qrcode("h5qr-temp");
        scanner.scanFile(file, false)
            .then(function(text) {
                showUploadSuccess(text, statusDiv, resultDiv);
            })
            .catch(function() {
                statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <strong>Method 4 of 4 ‚Äî Server scan...</strong>';
                tryServerScan(file, statusDiv, resultDiv);
            });
    }

    // Method 4: Send to server for Python scanning
    function tryServerScan(file, statusDiv, resultDiv) {
        var formData = new FormData();
        formData.append('image', file);

        fetch('/api/scan/image', {
            method: 'POST',
            body: formData
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.found && data.barcode) {
                showUploadSuccess(data.barcode, statusDiv, resultDiv);
            } else {
                // Try enhanced image on server
                tryEnhancedServerScan(file, statusDiv, resultDiv);
            }
        })
        .catch(function() {
            tryEnhancedServerScan(file, statusDiv, resultDiv);
        });
    }

    // Method 4b: Enhance image then send to server
    function tryEnhancedServerScan(file, statusDiv, resultDiv) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.getElementById('work-canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // Black and white enhancement
            try {
                var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                var data = imageData.data;
                for (var i = 0; i < data.length; i += 4) {
                    var gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                    data[i] = data[i+1] = data[i+2] = gray > 120 ? 255 : 0;
                }
                ctx.putImageData(imageData, 0, 0);
            } catch(e) {}

            canvas.toBlob(function(blob) {
                if (!blob) {
                    showUploadFail(statusDiv, resultDiv);
                    return;
                }

                // Try QuaggaJS on enhanced image
                var enhancedUrl = URL.createObjectURL(blob);
                Quagga.decodeSingle({
                    src: enhancedUrl,
                    numOfWorkers: 0,
                    inputStream: { size: 1920 },
                    locator: { patchSize: "large", halfSample: false },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "upc_reader", "code_128_reader"]
                    },
                    locate: true
                }, function(result) {
                    URL.revokeObjectURL(enhancedUrl);
                    if (result && result.codeResult && result.codeResult.code) {
                        showUploadSuccess(result.codeResult.code, statusDiv, resultDiv);
                    } else {
                        // Send enhanced to server too
                        var formData = new FormData();
                        formData.append('image', blob, 'enhanced.png');

                        fetch('/api/scan/image', {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(r) { return r.json(); })
                        .then(function(data) {
                            if (data.found && data.barcode) {
                                showUploadSuccess(data.barcode, statusDiv, resultDiv);
                            } else {
                                // Try QuaggaJS on image regions
                                tryRegionScans(img, statusDiv, resultDiv);
                            }
                        })
                        .catch(function() {
                            tryRegionScans(img, statusDiv, resultDiv);
                        });
                    }
                });
            }, 'image/png');
        };
        img.src = URL.createObjectURL(file);
    }

    // Method 5: Scan different regions of the image with QuaggaJS
    function tryRegionScans(img, statusDiv, resultDiv) {
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <strong>Scanning image regions...</strong>';

        var canvas = document.getElementById('work-canvas');
        var ctx = canvas.getContext('2d');

        var regions = [
            { x: 0, y: 0.5, w: 1.0, h: 0.5 },
            { x: 0, y: 0.6, w: 1.0, h: 0.4 },
            { x: 0, y: 0, w: 1.0, h: 0.5 },
            { x: 0.1, y: 0.3, w: 0.8, h: 0.5 },
            { x: 0, y: 0.3, w: 1.0, h: 0.4 },
            { x: 0, y: 0, w: 0.5, h: 1.0 },
            { x: 0.5, y: 0, w: 0.5, h: 1.0 },
            { x: 0, y: 0.5, w: 0.5, h: 0.5 },
            { x: 0.5, y: 0.5, w: 0.5, h: 0.5 }
        ];

        var rIdx = 0;

        function tryNextRegion() {
            if (rIdx >= regions.length) {
                showUploadFail(statusDiv, resultDiv);
                return;
            }

            var r = regions[rIdx];
            var sx = Math.floor(img.width * r.x);
            var sy = Math.floor(img.height * r.y);
            var sw = Math.floor(img.width * r.w);
            var sh = Math.floor(img.height * r.h);

            canvas.width = sw;
            canvas.height = sh;
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

            canvas.toBlob(function(blob) {
                if (!blob) { rIdx++; tryNextRegion(); return; }

                var regionUrl = URL.createObjectURL(blob);
                Quagga.decodeSingle({
                    src: regionUrl,
                    numOfWorkers: 0,
                    inputStream: { size: 1280 },
                    locator: { patchSize: "medium", halfSample: true },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "upc_reader", "code_128_reader"]
                    },
                    locate: true
                }, function(result) {
                    URL.revokeObjectURL(regionUrl);
                    if (result && result.codeResult && result.codeResult.code) {
                        showUploadSuccess(result.codeResult.code, statusDiv, resultDiv);
                    } else {
                        rIdx++;
                        tryNextRegion();
                    }
                });
            }, 'image/png');
        }

        tryNextRegion();
    }

    function showUploadSuccess(barcode, statusDiv, resultDiv) {
        statusDiv.style.display = 'none';
        playBeep();

        resultDiv.innerHTML = '‚úÖ <strong>Found:</strong> <span class="fs-4">' + barcode + '</span><br><span class="text-muted">Redirecting...</span>';
        resultDiv.className = 'mt-3 alert alert-success';
        resultDiv.style.display = 'block';

        setTimeout(function() {
            window.location.href = '/result/' + encodeURIComponent(barcode);
        }, 800);
    }

    function showUploadFail(statusDiv, resultDiv) {
        statusDiv.style.display = 'none';
        resultDiv.innerHTML = '‚ùå <strong>Could not detect barcode.</strong><br><br>' +
            '<strong>üì∑ Camera scanning works best!</strong><br>' +
            'The camera scanner detected barcodes perfectly.<br><br>' +
            '<button class="btn btn-primary btn-sm" onclick="switchToCamera()">üì∑ Use Camera Instead</button>' +
            ' <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById(\'gallery-upload\').click()">üñºÔ∏è Try Another Photo</button>' +
            ' <button class="btn btn-outline-secondary btn-sm" onclick="switchToManual()">‚å®Ô∏è Enter Manually</button>';
        resultDiv.className = 'mt-3 alert alert-warning';
        resultDiv.style.display = 'block';
    }

    // ============================================================
    // MANUAL ENTRY
    // ============================================================
    function fillBarcode(code) {
        document.getElementById('manual-barcode').value = code;
        lookupManualBarcode();
    }

    function lookupManualBarcode() {
        var barcode = document.getElementById('manual-barcode').value.trim();
        if (!barcode || !/^\d+$/.test(barcode)) return;
        window.location.href = '/result/' + encodeURIComponent(barcode);
    }

    function switchToManual() { new bootstrap.Tab(document.getElementById('manual-tab')).show(); }
    function switchToCamera() {
        new bootstrap.Tab(document.getElementById('camera-tab')).show();
        setTimeout(function() { startScanner(); }, 500);
    }

    function playBeep() {
        try {
            var ac = new (window.AudioContext || window.webkitAudioContext)();
            var o = ac.createOscillator();
            var g = ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.frequency.value = 800; g.gain.value = 0.3;
            o.start(); setTimeout(function() { o.stop(); }, 200);
        } catch(e) {}
        try { navigator.vibrate(200); } catch(e) {}
    }

    // Auto-start
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() { startScanner(); }, 500);
    });
    window.addEventListener('beforeunload', function() { stopScanner(); });
    document.querySelectorAll('#scanTabs button').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(e) {
            if (e.target.id !== 'camera-tab') stopScanner();
        });
    });
</script>
{% endblock %}