{% extends "base.html" %}

{% block title %}Scan Product - BharatScan{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="text-center mb-4">
                <h2>üîç Scan Product Barcode</h2>
                <p class="text-muted">Use your camera, upload an image, or enter barcode manually</p>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs nav-fill mb-4" id="scanTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="camera-tab" data-bs-toggle="tab" 
                            data-bs-target="#camera-panel" type="button" role="tab">
                        üì∑ Camera
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" 
                            data-bs-target="#upload-panel" type="button" role="tab">
                        üì§ Upload Image
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-tab" data-bs-toggle="tab" 
                            data-bs-target="#manual-panel" type="button" role="tab">
                        ‚å®Ô∏è Manual Entry
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="scanTabContent">
                
                <!-- CAMERA TAB -->
                <div class="tab-pane fade show active" id="camera-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            
                            <div id="reader" style="width: 100%; max-width: 600px; margin: 0 auto;"></div>
                            
                            <div id="camera-status" class="mt-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2">Initializing camera...</span>
                            </div>

                            <div id="scan-success" class="alert alert-success mt-3" style="display: none;">
                                <strong>‚úÖ Barcode Detected!</strong>
                                <br>
                                <span id="detected-barcode" class="fs-5 fw-bold"></span>
                                <br>
                                <span class="text-muted" id="detected-format"></span>
                            </div>

                            <div id="scan-error" class="alert alert-danger mt-3" style="display: none;"></div>
                            
                            <div class="mt-3">
                                <button id="btn-start-camera" class="btn btn-success btn-lg me-2" onclick="startScanner()">
                                    ‚ñ∂Ô∏è Start Camera
                                </button>
                                <button id="btn-stop-camera" class="btn btn-danger btn-lg" onclick="stopScanner()" style="display: none;">
                                    ‚èπÔ∏è Stop Camera
                                </button>
                            </div>

                            <div class="mt-3 p-3 bg-light rounded">
                                <small class="text-muted">
                                    <strong>Tips for best scanning:</strong><br>
                                    üìè Hold the barcode 4-8 inches from camera<br>
                                    üí° Make sure there's good lighting<br>
                                    üéØ Center the barcode inside the scanning box<br>
                                    üì± Hold your phone steady for 3-5 seconds<br>
                                    üîÑ Try tilting the product slightly if not detecting
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UPLOAD TAB -->
                <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <div class="mb-4">
                                <h5 class="mt-2">üì§ Upload Barcode Image</h5>
                                <p class="text-muted">Take a photo or select from gallery</p>
                                <div class="alert alert-info">
                                    <strong>üì∏ Photo Tips:</strong><br>
                                    ‚Ä¢ Get as close to the barcode as possible<br>
                                    ‚Ä¢ Barcode should fill most of the photo<br>
                                    ‚Ä¢ Good lighting, no shadows on barcode<br>
                                    ‚Ä¢ Hold camera steady, avoid blur
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="btn btn-primary w-100" for="barcode-camera-capture">
                                        üì∑ Take Photo
                                    </label>
                                    <input type="file" id="barcode-camera-capture" class="d-none" 
                                           accept="image/*" capture="environment" onchange="handleImageUpload(event)">
                                </div>
                                <div class="col-6">
                                    <label class="btn btn-outline-primary w-100" for="barcode-gallery">
                                        üñºÔ∏è From Gallery
                                    </label>
                                    <input type="file" id="barcode-gallery" class="d-none" 
                                           accept="image/*" onchange="handleImageUpload(event)">
                                </div>
                            </div>
                            
                            <div id="upload-preview" class="mb-3" style="display: none;">
                                <img id="preview-image" src="" alt="Preview" 
                                     style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                            </div>

                            <div id="upload-status" class="mt-3" style="display: none;"></div>
                            
                            <div id="upload-result" class="mt-3" style="display: none;"></div>

                            <!-- Canvas for image processing (hidden) -->
                            <canvas id="barcode-canvas" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- MANUAL ENTRY TAB -->
                <div class="tab-pane fade" id="manual-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="text-center mb-3">Enter Barcode Number</h5>
                            <p class="text-muted text-center">Type the number printed below the barcode lines</p>
                            
                            <div class="input-group input-group-lg mb-3">
                                <input type="text" id="manual-barcode" class="form-control" 
                                       placeholder="e.g., 8901058851854" 
                                       maxlength="13" pattern="[0-9]*" inputmode="numeric"
                                       onkeypress="if(event.key === 'Enter') lookupManualBarcode();">
                                <button class="btn btn-primary" onclick="lookupManualBarcode()">
                                    üîç Search
                                </button>
                            </div>

                            <div id="manual-result" class="mt-3" style="display: none;"></div>

                            <div class="mt-4">
                                <h6>üß™ Try These Sample Barcodes:</h6>
                                <div class="row g-2 mt-2">
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901058851854')">
                                            Parle-G Gold
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901262150255')">
                                            Maggi Noodles
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901790753456')">
                                            Crocin 500mg
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901689152012')">
                                            Himalaya Ashvagandha
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901030697289')">
                                            Lakme SPF 50
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901030718960')">
                                            Dove Shampoo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode library for camera scanning -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- ZXing library for better barcode detection from images -->
<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

<script>
    var html5QrCode = null;
    var isScanning = false;
    var zxingReader = null;

    // Initialize ZXing reader when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize ZXing for image scanning
        try {
            zxingReader = new ZXing.BrowserMultiFormatReader();
            console.log("ZXing library loaded successfully");
        } catch(e) {
            console.log("ZXing not available, will use html5-qrcode only");
        }

        var statusDiv = document.getElementById('camera-status');
        
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            statusDiv.innerHTML = 'üì∑ Camera available. Click <strong>Start Camera</strong> to begin scanning.';
            setTimeout(function() {
                startScanner();
            }, 500);
        } else {
            statusDiv.innerHTML = '‚ö†Ô∏è Camera not available. Use Upload or Manual Entry instead.';
            statusDiv.className = 'mt-3 alert alert-warning';
        }
    });

    // ============================================================
    // CAMERA SCANNER
    // ============================================================
    
    function startScanner() {
        var statusDiv = document.getElementById('camera-status');
        var successDiv = document.getElementById('scan-success');
        var errorDiv = document.getElementById('scan-error');
        
        successDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <span class="ms-2">Starting camera...</span>';
        statusDiv.style.display = 'block';
        
        document.getElementById('btn-start-camera').style.display = 'none';
        document.getElementById('btn-stop-camera').style.display = 'inline-block';

        html5QrCode = new Html5Qrcode("reader");

        var config = {
            fps: 15,
            qrbox: function(viewfinderWidth, viewfinderHeight) {
                var minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                var boxWidth = Math.floor(minEdge * 0.85);
                var boxHeight = Math.floor(boxWidth * 0.4);
                return { width: boxWidth, height: boxHeight };
            },
            aspectRatio: 1.0,
            formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.CODE_93,
                Html5QrcodeSupportedFormats.CODABAR,
                Html5QrcodeSupportedFormats.ITF,
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.DATA_MATRIX
            ],
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanFailure
        ).then(function() {
            isScanning = true;
            statusDiv.innerHTML = 'üü¢ <span class="text-success">Camera active ‚Äî point at a barcode</span>';
            console.log("Scanner started successfully");
        }).catch(function(err) {
            console.error("Back camera error:", err);
            
            html5QrCode.start(
                { facingMode: "user" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(function() {
                isScanning = true;
                statusDiv.innerHTML = 'üü¢ <span class="text-success">Front camera active ‚Äî point at a barcode</span>';
                statusDiv.style.display = 'block';
            }).catch(function(err2) {
                console.error("Front camera also failed:", err2);
                errorDiv.innerHTML = '<strong>‚ùå Camera Error</strong><br>' + 
                    'Could not access camera.<br>' +
                    '‚Ä¢ Allow camera permission when prompted<br>' +
                    '‚Ä¢ Try Upload or Manual Entry tabs instead';
                errorDiv.style.display = 'block';
                statusDiv.style.display = 'none';
                document.getElementById('btn-start-camera').style.display = 'inline-block';
                document.getElementById('btn-stop-camera').style.display = 'none';
            });
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log("BARCODE DETECTED:", decodedText);
        
        stopScanner();

        var successDiv = document.getElementById('scan-success');
        document.getElementById('detected-barcode').textContent = decodedText;
        document.getElementById('detected-format').textContent = 
            'Format: ' + decodedResult.result.format.formatName;
        successDiv.style.display = 'block';
        
        try {
            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var oscillator = audioCtx.createOscillator();
            var gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = 800;
            gainNode.gain.value = 0.1;
            oscillator.start();
            setTimeout(function() { oscillator.stop(); }, 150);
        } catch(e) {}

        setTimeout(function() {
            window.location.href = '/result/' + encodeURIComponent(decodedText);
        }, 800);
    }

    function onScanFailure(error) {
        // Normal ‚Äî fires every frame when no barcode detected
    }

    function stopScanner() {
        if (html5QrCode && isScanning) {
            html5QrCode.stop().then(function() {
                isScanning = false;
                document.getElementById('camera-status').innerHTML = '‚è∏Ô∏è Camera stopped';
                document.getElementById('btn-start-camera').style.display = 'inline-block';
                document.getElementById('btn-stop-camera').style.display = 'none';
            }).catch(function(err) {
                console.error("Error stopping scanner:", err);
                isScanning = false;
            });
        }
    }

    // ============================================================
    // IMAGE UPLOAD ‚Äî MULTI-METHOD SCANNING
    // Tries 3 methods: ZXing, html5-qrcode, and cropped scanning
    // ============================================================
    function handleImageUpload(event) {
        var file = event.target.files[0];
        if (!file) return;

        var previewDiv = document.getElementById('upload-preview');
        var previewImg = document.getElementById('preview-image');
        var statusDiv = document.getElementById('upload-status');
        var resultDiv = document.getElementById('upload-result');
        
        previewImg.src = URL.createObjectURL(file);
        previewDiv.style.display = 'block';
        
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <strong>Scanning barcode...</strong><br><small>Trying multiple detection methods...</small>';
        statusDiv.className = 'mt-3 alert alert-info';
        statusDiv.style.display = 'block';
        resultDiv.style.display = 'none';

        // Load image first
        var img = new Image();
        img.onload = function() {
            console.log("Image loaded:", img.width, "x", img.height);
            
            // Try Method 1: ZXing (best at finding barcodes in noisy images)
            tryZXingScan(file, img, function(barcode) {
                if (barcode) {
                    showUploadSuccess(barcode, 'ZXing');
                    return;
                }
                
                // Try Method 2: html5-qrcode
                tryHtml5QrCodeScan(file, function(barcode2) {
                    if (barcode2) {
                        showUploadSuccess(barcode2, 'html5-qrcode');
                        return;
                    }
                    
                    // Try Method 3: Scan different crops of the image
                    tryCroppedScan(img, function(barcode3) {
                        if (barcode3) {
                            showUploadSuccess(barcode3, 'cropped-scan');
                            return;
                        }
                        
                        // All methods failed
                        statusDiv.style.display = 'none';
                        resultDiv.innerHTML = '‚ùå <strong>Could not detect barcode.</strong><br><br>' +
                            '<strong>Try these tips:</strong><br>' +
                            'üì∏ Take the photo CLOSER to just the barcode<br>' +
                            'üí° Make sure good lighting, no shadows<br>' +
                            'üìè Barcode should be clear and not blurry<br>' +
                            'üîÑ Try again or use Manual Entry tab<br><br>' +
                            '<button class="btn btn-primary btn-sm" onclick="document.getElementById(\'barcode-camera-capture\').click()">üì∑ Try Again</button>' +
                            ' <button class="btn btn-outline-secondary btn-sm" onclick="switchToManual()">‚å®Ô∏è Enter Manually</button>';
                        resultDiv.className = 'mt-3 alert alert-warning';
                        resultDiv.style.display = 'block';
                    });
                });
            });
        };
        img.src = URL.createObjectURL(file);
    }

    // Method 1: ZXing ‚Äî best at finding barcodes in complex images
    function tryZXingScan(file, img, callback) {
        if (!zxingReader) {
            console.log("ZXing not available");
            callback(null);
            return;
        }

        try {
            var tempImg = document.createElement('img');
            tempImg.src = img.src;
            tempImg.onload = function() {
                zxingReader.decodeFromImage(tempImg)
                    .then(function(result) {
                        console.log("ZXing found barcode:", result.getText());
                        callback(result.getText());
                    })
                    .catch(function(err) {
                        console.log("ZXing scan failed:", err);
                        callback(null);
                    });
            };
        } catch(e) {
            console.log("ZXing error:", e);
            callback(null);
        }
    }

    // Method 2: html5-qrcode file scan
    function tryHtml5QrCodeScan(file, callback) {
        try {
            var tempDiv = document.getElementById('upload-temp-reader');
            if (!tempDiv) {
                tempDiv = document.createElement('div');
                tempDiv.id = 'upload-temp-reader';
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
            }

            var scanner = new Html5Qrcode("upload-temp-reader");
            scanner.scanFile(file, false)
                .then(function(decodedText) {
                    console.log("html5-qrcode found barcode:", decodedText);
                    callback(decodedText);
                })
                .catch(function(err) {
                    console.log("html5-qrcode scan failed:", err);
                    callback(null);
                });
        } catch(e) {
            console.log("html5-qrcode error:", e);
            callback(null);
        }
    }

    // Method 3: Try scanning different cropped regions of the image
    function tryCroppedScan(img, callback) {
        if (!zxingReader) {
            callback(null);
            return;
        }

        var canvas = document.getElementById('barcode-canvas');
        var ctx = canvas.getContext('2d');
        
        // Define crop regions to try (where barcodes are usually located)
        var crops = [
            // Bottom half (barcodes often at bottom of product)
            { x: 0, y: 0.5, w: 1.0, h: 0.5 },
            // Bottom third
            { x: 0, y: 0.66, w: 1.0, h: 0.34 },
            // Middle section
            { x: 0, y: 0.25, w: 1.0, h: 0.5 },
            // Top half
            { x: 0, y: 0, w: 1.0, h: 0.5 },
            // Center region
            { x: 0.15, y: 0.15, w: 0.7, h: 0.7 },
            // Left half
            { x: 0, y: 0, w: 0.5, h: 1.0 },
            // Right half
            { x: 0.5, y: 0, w: 0.5, h: 1.0 },
            // Bottom-left quarter
            { x: 0, y: 0.5, w: 0.5, h: 0.5 },
            // Bottom-right quarter
            { x: 0.5, y: 0.5, w: 0.5, h: 0.5 }
        ];

        var cropIndex = 0;

        function tryNextCrop() {
            if (cropIndex >= crops.length) {
                callback(null);
                return;
            }

            var crop = crops[cropIndex];
            var sx = Math.floor(img.width * crop.x);
            var sy = Math.floor(img.height * crop.y);
            var sw = Math.floor(img.width * crop.w);
            var sh = Math.floor(img.height * crop.h);

            canvas.width = sw;
            canvas.height = sh;

            // Draw cropped region
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

            // Also try with enhanced contrast
            try {
                var imageData = ctx.getImageData(0, 0, sw, sh);
                var data = imageData.data;
                
                // Convert to high contrast black and white
                for (var i = 0; i < data.length; i += 4) {
                    var gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                    var bw = gray > 128 ? 255 : 0;
                    data[i] = bw;
                    data[i+1] = bw;
                    data[i+2] = bw;
                }
                ctx.putImageData(imageData, 0, 0);
            } catch(e) {
                // If canvas manipulation fails, continue with original crop
            }

            // Convert canvas to image and scan
            var cropImgSrc = canvas.toDataURL('image/png');
            var cropImg = new Image();
            cropImg.onload = function() {
                zxingReader.decodeFromImage(cropImg)
                    .then(function(result) {
                        console.log("Found barcode in crop " + cropIndex + ":", result.getText());
                        callback(result.getText());
                    })
                    .catch(function() {
                        cropIndex++;
                        tryNextCrop();
                    });
            };
            cropImg.src = cropImgSrc;
        }

        tryNextCrop();
    }

    function showUploadSuccess(barcode, method) {
        var statusDiv = document.getElementById('upload-status');
        var resultDiv = document.getElementById('upload-result');
        
        console.log("Barcode found by " + method + ": " + barcode);
        
        statusDiv.style.display = 'none';
        resultDiv.innerHTML = '‚úÖ <strong>Barcode Found:</strong> <span class="fs-5">' + barcode + '</span>' +
            '<br><small class="text-muted">Detected using ' + method + '</small>' +
            '<br><a href="/result/' + encodeURIComponent(barcode) + 
            '" class="btn btn-primary btn-sm mt-2">View Product Details ‚Üí</a>';
        resultDiv.className = 'mt-3 alert alert-success';
        resultDiv.style.display = 'block';
        
        // Auto-redirect after 1.5 seconds
        setTimeout(function() {
            window.location.href = '/result/' + encodeURIComponent(barcode);
        }, 1500);
    }

    function switchToManual() {
        var manualTab = document.getElementById('manual-tab');
        var tab = new bootstrap.Tab(manualTab);
        tab.show();
    }

    // ============================================================
    // MANUAL BARCODE ENTRY
    // ============================================================
    function fillBarcode(code) {
        document.getElementById('manual-barcode').value = code;
        lookupManualBarcode();
    }

    function lookupManualBarcode() {
        var barcode = document.getElementById('manual-barcode').value.trim();
        var resultDiv = document.getElementById('manual-result');
        
        if (!barcode) {
            resultDiv.innerHTML = '‚ö†Ô∏è Please enter a barcode number';
            resultDiv.className = 'mt-3 alert alert-warning';
            resultDiv.style.display = 'block';
            return;
        }

        if (!/^\d+$/.test(barcode)) {
            resultDiv.innerHTML = '‚ö†Ô∏è Barcode should contain only numbers';
            resultDiv.className = 'mt-3 alert alert-warning';
            resultDiv.style.display = 'block';
            return;
        }

        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Looking up product...';
        resultDiv.className = 'mt-3 alert alert-info';
        resultDiv.style.display = 'block';

        window.location.href = '/result/' + encodeURIComponent(barcode);
    }

    // Stop scanner when leaving page
    window.addEventListener('beforeunload', function() {
        stopScanner();
    });

    // Stop scanner when switching tabs
    document.querySelectorAll('#scanTabs button').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(e) {
            if (e.target.id !== 'camera-tab') {
                stopScanner();
            }
        });
    });
</script>
{% endblock %}