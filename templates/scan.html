{% extends "base.html" %}

{% block title %}Scan Product - BharatScan{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="text-center mb-4">
                <h2>üîç Scan Product Barcode</h2>
                <p class="text-muted">Use your camera, upload an image, or enter barcode manually</p>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs nav-fill mb-4" id="scanTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="camera-tab" data-bs-toggle="tab" 
                            data-bs-target="#camera-panel" type="button" role="tab">
                        üì∑ Camera
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" 
                            data-bs-target="#upload-panel" type="button" role="tab">
                        üì§ Upload Image
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-tab" data-bs-toggle="tab" 
                            data-bs-target="#manual-panel" type="button" role="tab">
                        ‚å®Ô∏è Manual Entry
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="scanTabContent">
                
                <!-- CAMERA TAB -->
                <div class="tab-pane fade show active" id="camera-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            
                            <div id="reader" style="width: 100%; max-width: 600px; margin: 0 auto;"></div>
                            
                            <div id="camera-status" class="mt-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2">Initializing camera...</span>
                            </div>

                            <div id="scan-success" class="alert alert-success mt-3" style="display: none;">
                                <strong>‚úÖ Barcode Detected!</strong>
                                <br>
                                <span id="detected-barcode" class="fs-5 fw-bold"></span>
                                <br>
                                <span class="text-muted" id="detected-format"></span>
                            </div>

                            <div id="scan-error" class="alert alert-danger mt-3" style="display: none;"></div>
                            
                            <div class="mt-3">
                                <button id="btn-start-camera" class="btn btn-success btn-lg me-2" onclick="startScanner()">
                                    ‚ñ∂Ô∏è Start Camera
                                </button>
                                <button id="btn-stop-camera" class="btn btn-danger btn-lg" onclick="stopScanner()" style="display: none;">
                                    ‚èπÔ∏è Stop Camera
                                </button>
                            </div>

                            <div class="mt-3 p-3 bg-light rounded">
                                <small class="text-muted">
                                    <strong>Tips for best scanning:</strong><br>
                                    üìè Hold the barcode 6-10 inches from camera<br>
                                    üí° Make sure there's good lighting<br>
                                    üéØ Center the barcode inside the scanning box<br>
                                    üì± Hold your phone steady<br>
                                    üîÑ Try both horizontal and vertical orientation
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UPLOAD TAB -->
                <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <div class="mb-4">
                                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iIzY2NiI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZWVlIiByeD0iOCIvPjx0ZXh0IHg9IjMyIiB5PSIzNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMiI+8J+TpDwvdGV4dD48L3N2Zz4=" 
                                     alt="Upload" style="width: 80px; opacity: 0.5;">
                                <h5 class="mt-2">Upload Barcode Image</h5>
                                <p class="text-muted">Select or take a photo of the barcode</p>
                            </div>
                            
                            <input type="file" id="barcode-upload" class="form-control mb-3" 
                                   accept="image/*" capture="environment" onchange="handleImageUpload(event)">
                            
                            <div id="upload-preview" class="mb-3" style="display: none;">
                                <img id="preview-image" src="" alt="Preview" 
                                     style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                            </div>
                            
                            <div id="upload-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- MANUAL ENTRY TAB -->
                <div class="tab-pane fade" id="manual-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="text-center mb-3">Enter Barcode Number</h5>
                            <p class="text-muted text-center">Type the number printed below the barcode</p>
                            
                            <div class="input-group input-group-lg mb-3">
                                <input type="text" id="manual-barcode" class="form-control" 
                                       placeholder="e.g., 8901058851854" 
                                       maxlength="13" pattern="[0-9]*" inputmode="numeric"
                                       onkeypress="if(event.key === 'Enter') lookupManualBarcode();">
                                <button class="btn btn-primary" onclick="lookupManualBarcode()">
                                    üîç Search
                                </button>
                            </div>

                            <div id="manual-result" class="mt-3" style="display: none;"></div>

                            <!-- Sample barcodes for quick testing -->
                            <div class="mt-4">
                                <h6>üß™ Try These Sample Barcodes:</h6>
                                <div class="row g-2 mt-2">
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901058851854')">
                                            Parle-G Gold
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901262150255')">
                                            Maggi Noodles
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901790753456')">
                                            Crocin 500mg
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901689152012')">
                                            Himalaya Ashvagandha
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901030697289')">
                                            Lakme SPF 50
                                        </button>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" 
                                                onclick="fillBarcode('8901030718960')">
                                            Dove Shampoo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    let html5QrCode = null;
    let isScanning = false;

    // ============================================================
    // CAMERA SCANNER ‚Äî with ALL barcode formats enabled
    // ============================================================
    
    function startScanner() {
        const readerDiv = document.getElementById('reader');
        const statusDiv = document.getElementById('camera-status');
        const successDiv = document.getElementById('scan-success');
        const errorDiv = document.getElementById('scan-error');
        
        // Reset UI
        successDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <span class="ms-2">Starting camera...</span>';
        statusDiv.style.display = 'block';
        
        document.getElementById('btn-start-camera').style.display = 'none';
        document.getElementById('btn-stop-camera').style.display = 'inline-block';

        // Create new scanner instance
        html5QrCode = new Html5Qrcode("reader");

        // ALL barcode formats including EAN_13 for Indian products
        const config = {
            fps: 15,
            qrbox: function(viewfinderWidth, viewfinderHeight) {
                let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                let boxWidth = Math.floor(minEdge * 0.85);
                let boxHeight = Math.floor(boxWidth * 0.45);
                return { width: boxWidth, height: boxHeight };
            },
            aspectRatio: 1.0,
            formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.CODE_93,
                Html5QrcodeSupportedFormats.CODABAR,
                Html5QrcodeSupportedFormats.ITF,
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.DATA_MATRIX
            ],
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };

        // Prefer back camera
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanFailure
        ).then(function() {
            isScanning = true;
            statusDiv.innerHTML = 'üü¢ <span class="text-success">Camera active ‚Äî point at a barcode</span>';
            console.log("Scanner started successfully");
        }).catch(function(err) {
            console.error("Camera start error:", err);
            statusDiv.style.display = 'none';
            
            // Try front camera as fallback
            console.log("Trying front camera...");
            html5QrCode.start(
                { facingMode: "user" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(function() {
                isScanning = true;
                statusDiv.innerHTML = 'üü¢ <span class="text-success">Front camera active ‚Äî point at a barcode</span>';
                statusDiv.style.display = 'block';
            }).catch(function(err2) {
                console.error("Front camera also failed:", err2);
                errorDiv.innerHTML = '<strong>‚ùå Camera Error</strong><br>' + 
                    'Could not access camera. Please try:<br>' +
                    '‚Ä¢ Allow camera permission when prompted<br>' +
                    '‚Ä¢ Use HTTPS (camera requires secure context)<br>' +
                    '‚Ä¢ Try the Upload or Manual Entry tabs instead<br>' +
                    '<small class="text-muted">Error: ' + err2 + '</small>';
                errorDiv.style.display = 'block';
                statusDiv.style.display = 'none';
                document.getElementById('btn-start-camera').style.display = 'inline-block';
                document.getElementById('btn-stop-camera').style.display = 'none';
            });
        });
    }

    // ============================================================
    // SUCCESS CALLBACK ‚Äî barcode was read!
    // ============================================================
    function onScanSuccess(decodedText, decodedResult) {
        console.log("=== BARCODE DETECTED ===");
        console.log("Value:", decodedText);
        console.log("Format:", decodedResult.result.format.formatName);
        
        // Stop scanning immediately to prevent multiple reads
        stopScanner();

        // Show detected barcode on screen
        var successDiv = document.getElementById('scan-success');
        document.getElementById('detected-barcode').textContent = decodedText;
        document.getElementById('detected-format').textContent = 
            'Format: ' + decodedResult.result.format.formatName;
        successDiv.style.display = 'block';
        
        // Play a subtle beep
        try {
            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var oscillator = audioCtx.createOscillator();
            var gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = 800;
            gainNode.gain.value = 0.1;
            oscillator.start();
            setTimeout(function() { oscillator.stop(); }, 150);
        } catch(e) { /* ignore audio errors */ }

        // Redirect to result page
        setTimeout(function() {
            window.location.href = '/result/' + encodeURIComponent(decodedText);
        }, 800);
    }

    // ============================================================
    // FAILURE CALLBACK ‚Äî called continuously when no barcode found
    // ============================================================
    function onScanFailure(error) {
        // This fires every frame when no barcode is detected ‚Äî this is normal
    }

    // ============================================================
    // STOP SCANNER
    // ============================================================
    function stopScanner() {
        if (html5QrCode && isScanning) {
            html5QrCode.stop().then(function() {
                isScanning = false;
                console.log("Scanner stopped");
                document.getElementById('camera-status').innerHTML = '‚è∏Ô∏è Camera stopped';
                document.getElementById('btn-start-camera').style.display = 'inline-block';
                document.getElementById('btn-stop-camera').style.display = 'none';
            }).catch(function(err) {
                console.error("Error stopping scanner:", err);
                isScanning = false;
            });
        }
    }

    // ============================================================
    // IMAGE UPLOAD SCANNING
    // ============================================================
    function handleImageUpload(event) {
        var file = event.target.files[0];
        if (!file) return;

        // Show preview
        var previewDiv = document.getElementById('upload-preview');
        var previewImg = document.getElementById('preview-image');
        var resultDiv = document.getElementById('upload-result');
        
        previewImg.src = URL.createObjectURL(file);
        previewDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Scanning image...';
        resultDiv.className = 'mt-3 alert alert-info';
        resultDiv.style.display = 'block';

        // Create a temporary hidden div for the scanner if it doesn't exist
        var tempDiv = document.getElementById('upload-temp-reader');
        if (!tempDiv) {
            tempDiv = document.createElement('div');
            tempDiv.id = 'upload-temp-reader';
            tempDiv.style.display = 'none';
            document.body.appendChild(tempDiv);
        }

        // Scan the uploaded image
        var html5QrCodeForUpload = new Html5Qrcode("upload-temp-reader");

        html5QrCodeForUpload.scanFile(file, false)
            .then(function(decodedText) {
                console.log("Upload scan result:", decodedText);
                resultDiv.innerHTML = '‚úÖ <strong>Barcode Found:</strong> ' + decodedText + 
                    '<br><a href="/result/' + encodeURIComponent(decodedText) + 
                    '" class="btn btn-primary btn-sm mt-2">View Product Details ‚Üí</a>';
                resultDiv.className = 'mt-3 alert alert-success';
                
                // Auto-redirect after 1.5 seconds
                setTimeout(function() {
                    window.location.href = '/result/' + encodeURIComponent(decodedText);
                }, 1500);
            })
            .catch(function(err) {
                console.error("Upload scan error:", err);
                resultDiv.innerHTML = '‚ùå <strong>Could not read barcode from image.</strong><br>' +
                    'Tips: Make sure the barcode is clear, well-lit, and not blurry.<br>' +
                    'Try the Manual Entry tab instead.';
                resultDiv.className = 'mt-3 alert alert-warning';
            });
    }

    // ============================================================
    // MANUAL BARCODE ENTRY
    // ============================================================
    function fillBarcode(code) {
        document.getElementById('manual-barcode').value = code;
        lookupManualBarcode();
    }

    function lookupManualBarcode() {
        var barcode = document.getElementById('manual-barcode').value.trim();
        var resultDiv = document.getElementById('manual-result');
        
        if (!barcode) {
            resultDiv.innerHTML = '‚ö†Ô∏è Please enter a barcode number';
            resultDiv.className = 'mt-3 alert alert-warning';
            resultDiv.style.display = 'block';
            return;
        }

        if (!/^\d+$/.test(barcode)) {
            resultDiv.innerHTML = '‚ö†Ô∏è Barcode should contain only numbers';
            resultDiv.className = 'mt-3 alert alert-warning';
            resultDiv.style.display = 'block';
            return;
        }

        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Looking up product...';
        resultDiv.className = 'mt-3 alert alert-info';
        resultDiv.style.display = 'block';

        // Redirect to result page
        window.location.href = '/result/' + encodeURIComponent(barcode);
    }

    // ============================================================
    // AUTO-START camera when page loads
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
        var statusDiv = document.getElementById('camera-status');
        
        // Check if camera is available
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            statusDiv.innerHTML = 'üì∑ Camera available. Click <strong>Start Camera</strong> to begin scanning.';
            // Auto-start the scanner
            setTimeout(function() {
                startScanner();
            }, 500);
        } else {
            statusDiv.innerHTML = '‚ö†Ô∏è Camera not available. Use Upload or Manual Entry instead.';
            statusDiv.className = 'mt-3 alert alert-warning';
        }
    });

    // Stop scanner when user leaves the page
    window.addEventListener('beforeunload', function() {
        stopScanner();
    });

    // Stop scanner when switching tabs
    document.querySelectorAll('#scanTabs button').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(e) {
            if (e.target.id !== 'camera-tab') {
                stopScanner();
            }
        });
    });
</script>
{% endblock %}