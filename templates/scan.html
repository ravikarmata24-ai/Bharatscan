{% extends "base.html" %}

{% block title %}Scan Product - BharatScan{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="text-center mb-4">
                <h2>üîç Scan Product Barcode</h2>
                <p class="text-muted">Scan, upload, or enter barcode manually</p>
            </div>

            <ul class="nav nav-tabs nav-fill mb-4" id="scanTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="camera-tab" data-bs-toggle="tab" 
                            data-bs-target="#camera-panel" type="button" role="tab">üì∑ Camera</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" 
                            data-bs-target="#upload-panel" type="button" role="tab">üì§ Upload</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-tab" data-bs-toggle="tab" 
                            data-bs-target="#manual-panel" type="button" role="tab">‚å®Ô∏è Manual</button>
                </li>
            </ul>

            <div class="tab-content" id="scanTabContent">
                
                <!-- CAMERA TAB -->
                <div class="tab-pane fade show active" id="camera-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center p-2">
                            
                            <!-- QuaggaJS scanner viewport -->
                            <div id="scanner-container" style="position: relative; width: 100%; max-width: 600px; margin: 0 auto; overflow: hidden; border-radius: 12px; background: #000;">
                                <div id="interactive" class="viewport" style="width: 100%; height: 350px;"></div>
                                <!-- Scanning line animation -->
                                <div id="scan-line" style="position: absolute; top: 40%; left: 5%; right: 5%; height: 3px; background: #00ff00; box-shadow: 0 0 10px #00ff00; display: none; animation: scanMove 2s ease-in-out infinite;"></div>
                                <!-- Scan area guide -->
                                <div id="scan-guide" style="position: absolute; top: 25%; left: 5%; right: 5%; bottom: 25%; border: 2px solid rgba(0,255,0,0.5); border-radius: 8px; display: none;"></div>
                            </div>

                            <style>
                                #interactive video { width: 100% !important; height: 350px !important; object-fit: cover; }
                                #interactive canvas { display: none !important; }
                                @keyframes scanMove {
                                    0%, 100% { top: 30%; }
                                    50% { top: 60%; }
                                }
                            </style>
                            
                            <div id="camera-status" class="mt-2">
                                <span class="text-muted">Tap Start Camera to begin</span>
                            </div>

                            <div id="scan-success" class="alert alert-success mt-2" style="display: none;">
                                <strong>‚úÖ Barcode Detected!</strong><br>
                                <span id="detected-barcode" class="fs-4 fw-bold"></span><br>
                                <span class="text-muted">Redirecting...</span>
                            </div>

                            <div id="scan-error" class="alert alert-danger mt-2" style="display: none;"></div>
                            
                            <div class="mt-2">
                                <button id="btn-start" class="btn btn-success btn-lg me-2" onclick="startScanner()">‚ñ∂Ô∏è Start Camera</button>
                                <button id="btn-stop" class="btn btn-danger btn-lg" onclick="stopScanner()" style="display: none;">‚èπÔ∏è Stop</button>
                            </div>

                            <div class="mt-2 p-2 bg-light rounded">
                                <small class="text-muted">
                                    üì± Point at barcode and hold steady. Works from normal distance.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UPLOAD TAB -->
                <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <h5 class="mb-3">üì§ Upload Barcode Image</h5>
                            
                            <label class="btn btn-primary btn-lg w-100 py-3" for="gallery-upload">
                                üñºÔ∏è Choose Photo from Gallery
                            </label>
                            <input type="file" id="gallery-upload" class="d-none" 
                                   accept="image/*" 
                                   onchange="handleUpload(event)">
                            
                            <div id="upload-preview" class="mb-3 mt-3" style="display: none;">
                                <img id="preview-image" src="" alt="Preview" 
                                     style="max-width: 100%; max-height: 250px; border-radius: 8px;">
                            </div>

                            <div id="upload-status" class="mt-3" style="display: none;"></div>
                            <div id="upload-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- MANUAL TAB -->
                <div class="tab-pane fade" id="manual-panel" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="text-center mb-3">‚å®Ô∏è Enter Barcode Number</h5>
                            
                            <div class="input-group input-group-lg mb-3">
                                <input type="text" id="manual-barcode" class="form-control" 
                                       placeholder="e.g., 8901058851854" 
                                       maxlength="13" inputmode="numeric"
                                       onkeypress="if(event.key === 'Enter') lookupManualBarcode();">
                                <button class="btn btn-primary" onclick="lookupManualBarcode()">üîç Search</button>
                            </div>

                            <div id="manual-result" class="mt-3" style="display: none;"></div>

                            <div class="mt-4">
                                <h6>üß™ Sample Barcodes:</h6>
                                <div class="row g-2 mt-2">
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901058851854')">Parle-G Gold</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901262150255')">Maggi Noodles</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901790753456')">Crocin 500mg</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901689152012')">Himalaya Ashvagandha</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901030697289')">Lakme SPF 50</button></div>
                                    <div class="col-6 col-md-4"><button class="btn btn-outline-secondary btn-sm w-100" onclick="fillBarcode('8901030718960')">Dove Shampoo</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="upload-temp-reader" style="display: none;"></div>
<canvas id="work-canvas" style="display: none;"></canvas>
{% endblock %}

{% block extra_js %}
<!-- QuaggaJS ‚Äî FAST barcode scanner optimized for linear barcodes -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
<!-- html5-qrcode as backup for file scanning -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    var isScanning = false;
    var lastDetected = '';
    var detectionCount = 0;
    var REQUIRED_DETECTIONS = 2;

    // ============================================================
    // CAMERA SCANNER using QuaggaJS ‚Äî FAST, works from DISTANCE
    // ============================================================
    function startScanner() {
        var statusDiv = document.getElementById('camera-status');
        var successDiv = document.getElementById('scan-success');
        var errorDiv = document.getElementById('scan-error');

        successDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> Starting camera...';
        
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'inline-block';

        lastDetected = '';
        detectionCount = 0;

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment",
                    width: { min: 1280, ideal: 1920 },
                    height: { min: 720, ideal: 1080 },
                    aspectRatio: { ideal: 1.7778 }
                },
                area: {
                    top: "20%",
                    right: "5%",
                    left: "5%",
                    bottom: "20%"
                }
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            numOfWorkers: navigator.hardwareConcurrency ? Math.min(navigator.hardwareConcurrency, 4) : 2,
            frequency: 20,
            decoder: {
                readers: [
                    "ean_reader",
                    "ean_8_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "code_128_reader",
                    "code_39_reader"
                ],
                multiple: false
            },
            locate: true
        }, function(err) {
            if (err) {
                console.error('Quagga init error:', err);
                // Fallback to html5-qrcode
                startHtml5QrCodeFallback();
                return;
            }

            Quagga.start();
            isScanning = true;

            document.getElementById('scan-line').style.display = 'block';
            document.getElementById('scan-guide').style.display = 'block';

            statusDiv.innerHTML = 'üü¢ <span class="text-success"><strong>Camera active</strong> ‚Äî point at any barcode</span>';
        });

        // Listen for barcode detection
        Quagga.onDetected(function(result) {
            if (!isScanning) return;

            var code = result.codeResult.code;
            var format = result.codeResult.format;

            // Require same barcode detected twice for accuracy
            if (code === lastDetected) {
                detectionCount++;
            } else {
                lastDetected = code;
                detectionCount = 1;
            }

            if (detectionCount >= REQUIRED_DETECTIONS) {
                onBarcodeFound(code, format);
            }
        });
    }

    // Fallback scanner if QuaggaJS fails
    function startHtml5QrCodeFallback() {
        var statusDiv = document.getElementById('camera-status');
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> Starting backup scanner...';

        var scanner = new Html5Qrcode("interactive");
        var config = {
            fps: 15,
            qrbox: function(vw, vh) {
                return { width: Math.floor(vw * 0.85), height: Math.floor(vh * 0.45) };
            },
            formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.QR_CODE
            ]
        };

        scanner.start(
            { facingMode: "environment" },
            config,
            function(text, result) {
                onBarcodeFound(text, result.result.format.formatName);
                scanner.stop().catch(function() {});
            },
            function() {}
        ).then(function() {
            isScanning = true;
            statusDiv.innerHTML = 'üü¢ <span class="text-success">Camera active ‚Äî point at barcode</span>';
        }).catch(function(err) {
            statusDiv.innerHTML = '‚ùå Camera failed: ' + err;
            document.getElementById('btn-start').style.display = 'inline-block';
            document.getElementById('btn-stop').style.display = 'none';
        });
    }

    function onBarcodeFound(code, format) {
        isScanning = false;
        stopScanner();

        document.getElementById('detected-barcode').textContent = code;
        document.getElementById('scan-success').style.display = 'block';
        document.getElementById('camera-status').style.display = 'none';
        document.getElementById('scan-line').style.display = 'none';
        document.getElementById('scan-guide').style.display = 'none';

        // Beep
        try {
            var ac = new (window.AudioContext || window.webkitAudioContext)();
            var o = ac.createOscillator();
            var g = ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.frequency.value = 800; g.gain.value = 0.3;
            o.start(); setTimeout(function() { o.stop(); }, 200);
        } catch(e) {}

        // Vibrate if supported
        try { navigator.vibrate(200); } catch(e) {}

        setTimeout(function() {
            window.location.href = '/result/' + encodeURIComponent(code);
        }, 600);
    }

    function stopScanner() {
        try {
            Quagga.stop();
        } catch(e) {}
        isScanning = false;
        document.getElementById('scan-line').style.display = 'none';
        document.getElementById('scan-guide').style.display = 'none';
        document.getElementById('camera-status').innerHTML = '‚è∏Ô∏è Camera stopped';
        document.getElementById('btn-start').style.display = 'inline-block';
        document.getElementById('btn-stop').style.display = 'none';
    }

    // ============================================================
    // UPLOAD ‚Äî sends to SERVER for Python scanning
    // ============================================================
    function handleUpload(event) {
        var file = event.target.files[0];
        if (!file) return;

        var previewImg = document.getElementById('preview-image');
        var statusDiv = document.getElementById('upload-status');
        var resultDiv = document.getElementById('upload-result');

        previewImg.src = URL.createObjectURL(file);
        document.getElementById('upload-preview').style.display = 'block';

        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> <strong>Scanning...</strong>';
        statusDiv.className = 'mt-3 alert alert-info';
        statusDiv.style.display = 'block';
        resultDiv.style.display = 'none';

        // Method 1: Client-side html5-qrcode
        var scanner = new Html5Qrcode("upload-temp-reader");
        scanner.scanFile(file, false)
            .then(function(text) {
                showUploadSuccess(text, statusDiv, resultDiv);
            })
            .catch(function() {
                // Method 2: Send to server
                statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> Deep scanning on server...';

                var formData = new FormData();
                formData.append('image', file);

                fetch('/api/scan/image', {
                    method: 'POST',
                    body: formData
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.found && data.barcode) {
                        showUploadSuccess(data.barcode, statusDiv, resultDiv);
                    } else {
                        showUploadFail(statusDiv, resultDiv);
                    }
                })
                .catch(function() {
                    showUploadFail(statusDiv, resultDiv);
                });
            });
    }

    function showUploadSuccess(barcode, statusDiv, resultDiv) {
        statusDiv.style.display = 'none';
        try {
            var ac = new (window.AudioContext || window.webkitAudioContext)();
            var o = ac.createOscillator();
            var g = ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.frequency.value = 800; g.gain.value = 0.2;
            o.start(); setTimeout(function() { o.stop(); }, 150);
        } catch(e) {}
        try { navigator.vibrate(200); } catch(e) {}

        resultDiv.innerHTML = '‚úÖ <strong>Found:</strong> <span class="fs-4">' + barcode + '</span><br><span class="text-muted">Redirecting...</span>';
        resultDiv.className = 'mt-3 alert alert-success';
        resultDiv.style.display = 'block';
        setTimeout(function() { window.location.href = '/result/' + encodeURIComponent(barcode); }, 800);
    }

    function showUploadFail(statusDiv, resultDiv) {
        statusDiv.style.display = 'none';
        resultDiv.innerHTML = '‚ùå <strong>Could not detect barcode.</strong><br>' +
            'üì∏ Use a clear, close photo of the barcode<br>' +
            'üì∑ <strong>Camera scanning works best!</strong><br><br>' +
            '<button class="btn btn-primary btn-sm" onclick="document.getElementById(\'gallery-upload\').click()">üñºÔ∏è Try Another</button>' +
            ' <button class="btn btn-outline-primary btn-sm" onclick="switchToCamera()">üì∑ Camera</button>' +
            ' <button class="btn btn-outline-secondary btn-sm" onclick="switchToManual()">‚å®Ô∏è Manual</button>';
        resultDiv.className = 'mt-3 alert alert-warning';
        resultDiv.style.display = 'block';
    }

    // ============================================================
    // MANUAL ENTRY
    // ============================================================
    function fillBarcode(code) {
        document.getElementById('manual-barcode').value = code;
        lookupManualBarcode();
    }
    function lookupManualBarcode() {
        var barcode = document.getElementById('manual-barcode').value.trim();
        if (!barcode || !/^\d+$/.test(barcode)) return;
        window.location.href = '/result/' + encodeURIComponent(barcode);
    }
    function switchToManual() { new bootstrap.Tab(document.getElementById('manual-tab')).show(); }
    function switchToCamera() {
        new bootstrap.Tab(document.getElementById('camera-tab')).show();
        setTimeout(function() { startScanner(); }, 500);
    }

    // Auto-start
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() { startScanner(); }, 500);
    });
    window.addEventListener('beforeunload', function() { stopScanner(); });
    document.querySelectorAll('#scanTabs button').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(e) {
            if (e.target.id !== 'camera-tab') stopScanner();
        });
    });
</script>
{% endblock %}