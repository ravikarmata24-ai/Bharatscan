<!DOCTYPE html>
<html>
<head>
    <title>BharatScan - Safari Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { font-family: -apple-system, Arial; max-width: 600px; margin: 10px auto; padding: 10px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 8px; }
        .ok { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warn { background: #fff3cd; color: #856404; }
        button { padding: 14px 28px; margin: 5px; font-size: 17px; border-radius: 10px; border: 2px solid #333; background: #fff; -webkit-appearance: none; }
        button:active { background: #ddd; }
        #reader { width: 100%; max-width: 500px; margin: 0 auto; }
        #log { background: #1a1a1a; color: #0f0; padding: 15px; font-family: monospace;
               font-size: 11px; max-height: 300px; overflow-y: auto; border-radius: 8px;
               white-space: pre-wrap; -webkit-overflow-scrolling: touch; }
        .big-result { font-size: 22px; font-weight: bold; padding: 20px; text-align: center; }
        h3 { margin-top: 25px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>
    <h2>üîß BharatScan Safari Test</h2>
    <p>Optimized for iPhone Safari</p>

    <h3>1Ô∏è‚É£ Device Info</h3>
    <div id="device-info"></div>

    <h3>2Ô∏è‚É£ Camera Barcode Scan (html5-qrcode)</h3>
    <p>This uses the html5-qrcode library which works best on Safari.</p>
    <button onclick="startHtml5QrScan()">üì∑ Start Camera Scanner</button>
    <button onclick="stopHtml5QrScan()">‚èπÔ∏è Stop</button>
    <div id="reader"></div>
    <div id="h5-result"></div>

    <h3>3Ô∏è‚É£ Camera Barcode Scan (Direct Video + ZXing)</h3>
    <button onclick="startDirectScan()">üì∑ Start Direct Scanner</button>
    <button onclick="stopDirectScan()">‚èπÔ∏è Stop</button>
    <br><br>
    <video id="direct-video" autoplay playsinline muted style="width:100%; max-width:500px; background:#000; border-radius:8px;"></video>
    <div id="direct-result"></div>

    <h3>4Ô∏è‚É£ Photo Upload</h3>
    <p>Option A ‚Äî Take photo now:</p>
    <input type="file" accept="image/*" capture="environment" onchange="scanPhoto(event)" style="font-size:16px; margin:5px 0;">

    <p>Option B ‚Äî Pick from Photos app:</p>
    <input type="file" accept="image/png,image/jpeg,image/jpg" onchange="scanPhoto(event)" style="font-size:16px; margin:5px 0;">

    <div id="photo-preview" style="display:none; margin:10px 0;">
        <img id="photo-img" src="" style="max-width:100%; max-height:200px; border-radius:8px;">
    </div>
    <div id="photo-result"></div>

    <h3>üìã Debug Log</h3>
    <button onclick="document.getElementById('log').textContent=''">üóëÔ∏è Clear</button>
    <div id="log"></div>

    <canvas id="work-canvas" style="display:none;"></canvas>

    <!-- Load html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Load ZXing -->
    <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

    <script>
        var logDiv = document.getElementById('log');
        var html5Scanner = null;
        var directStream = null;
        var directInterval = null;
        var zxingReader = null;
        var lastPhotoImage = null;

        function log(msg) {
            var time = new Date().toLocaleTimeString();
            logDiv.textContent += time + ': ' + msg + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ============================
        // 1. Device Info
        // ============================
        function showDeviceInfo() {
            var info = document.getElementById('device-info');
            var ua = navigator.userAgent;
            var html = '';

            var isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
            var isIOS = /iPhone|iPad/.test(ua);
            var iosVersion = 'Unknown';
            var match = ua.match(/OS (\d+_\d+)/);
            if (match) iosVersion = match[1].replace('_', '.');

            html += '<div class="status info">';
            html += 'üì± <strong>iPhone detected</strong><br>';
            html += 'iOS Version: ' + iosVersion + '<br>';
            html += 'Safari: ' + (isSafari ? 'Yes' : 'No') + '<br>';
            html += 'HTTPS: ' + (location.protocol === 'https:' ? 'Yes ‚úÖ' : 'No ‚ùå') + '<br>';
            html += '</div>';

            // Check libraries
            if (typeof Html5Qrcode !== 'undefined') {
                html += '<div class="status ok">‚úÖ html5-qrcode loaded</div>';
                log('html5-qrcode: OK');
            } else {
                html += '<div class="status fail">‚ùå html5-qrcode failed</div>';
                log('html5-qrcode: FAILED');
            }

            if (typeof ZXing !== 'undefined') {
                html += '<div class="status ok">‚úÖ ZXing loaded</div>';
                log('ZXing: OK');
                try {
                    zxingReader = new ZXing.BrowserMultiFormatReader();
                    log('ZXing reader created');
                } catch(e) {
                    log('ZXing reader error: ' + e);
                }
            } else {
                html += '<div class="status fail">‚ùå ZXing failed</div>';
                log('ZXing: FAILED');
            }

            if (typeof BarcodeDetector !== 'undefined') {
                html += '<div class="status ok">‚úÖ Native BarcodeDetector available</div>';
                log('BarcodeDetector: YES');
            } else {
                html += '<div class="status warn">‚ö†Ô∏è Native BarcodeDetector not available</div>';
                log('BarcodeDetector: NO');
            }

            log('iOS: ' + iosVersion + ', Safari: ' + isSafari);
            log('UA: ' + ua);

            info.innerHTML = html;
        }
        showDeviceInfo();

        // ============================
        // 2. html5-qrcode Camera Scanner
        // This is the BEST method for Safari
        // ============================
        function startHtml5QrScan() {
            var result = document.getElementById('h5-result');
            result.innerHTML = '<div class="status info">Starting camera...</div>';
            log('Starting html5-qrcode scanner...');

            if (html5Scanner) {
                try { html5Scanner.stop(); } catch(e) {}
            }

            html5Scanner = new Html5Qrcode("reader");

            var config = {
                fps: 10,
                qrbox: function(viewfinderWidth, viewfinderHeight) {
                    var w = Math.floor(viewfinderWidth * 0.85);
                    var h = Math.floor(w * 0.4);
                    return { width: w, height: h };
                },
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.QR_CODE
                ],
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: false
                }
            };

            html5Scanner.start(
                { facingMode: "environment" },
                config,
                function(decodedText, decodedResult) {
                    // SUCCESS
                    log('*** html5-qrcode FOUND: ' + decodedText + ' ***');
                    log('Format: ' + decodedResult.result.format.formatName);
                    result.innerHTML = '<div class="status ok big-result">‚úÖ ' + decodedText + '</div>' +
                        '<div>Format: ' + decodedResult.result.format.formatName + '</div>' +
                        '<a href="/result/' + decodedText + '" style="font-size:18px;">View Product ‚Üí</a>';
                    stopHtml5QrScan();
                    playBeep();
                },
                function(errorMessage) {
                    // This fires every frame ‚Äî ignore it
                }
            ).then(function() {
                log('html5-qrcode camera started');
                result.innerHTML = '<div class="status ok">üü¢ Camera active ‚Äî point at barcode, hold steady</div>';
            }).catch(function(err) {
                log('html5-qrcode start error: ' + err);
                result.innerHTML = '<div class="status fail">‚ùå Camera error: ' + err + '</div>';
            });
        }

        function stopHtml5QrScan() {
            if (html5Scanner) {
                html5Scanner.stop().then(function() {
                    log('html5-qrcode stopped');
                }).catch(function(e) {
                    log('Stop error: ' + e);
                });
            }
        }

        // ============================
        // 3. Direct Video + ZXing Scanner
        // ============================
        function startDirectScan() {
            var result = document.getElementById('direct-result');
            result.innerHTML = '<div class="status info">Starting camera...</div>';

            if (directStream) {
                directStream.getTracks().forEach(function(t) { t.stop(); });
            }

            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: "environment" },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            }).then(function(stream) {
                directStream = stream;
                var video = document.getElementById('direct-video');
                video.srcObject = stream;

                var settings = stream.getVideoTracks()[0].getSettings();
                log('Direct camera: ' + (settings.width || '?') + 'x' + (settings.height || '?'));

                result.innerHTML = '<div class="status ok">üü¢ Camera active ‚Äî point at barcode</div>';

                // Start scanning frames
                var canvas = document.getElementById('work-canvas');
                var ctx = canvas.getContext('2d');
                var frameCount = 0;

                directInterval = setInterval(function() {
                    if (video.videoWidth === 0) return;
                    frameCount++;

                    if (frameCount % 25 === 0) {
                        log('Direct scan frame ' + frameCount + '...');
                    }

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);

                    // Convert to blob instead of dataURL (better for Safari)
                    canvas.toBlob(function(blob) {
                        if (!blob) return;
                        var url = URL.createObjectURL(blob);
                        var img = new Image();
                        img.onload = function() {
                            if (zxingReader) {
                                zxingReader.decodeFromImage(img)
                                    .then(function(res) {
                                        var barcode = res.getText();
                                        log('*** Direct FOUND: ' + barcode + ' ***');
                                        result.innerHTML = '<div class="status ok big-result">‚úÖ ' + barcode + '</div>' +
                                            '<a href="/result/' + barcode + '">View Product ‚Üí</a>';
                                        stopDirectScan();
                                        playBeep();
                                    })
                                    .catch(function() {})
                                    .finally(function() { URL.revokeObjectURL(url); });
                            }
                        };
                        img.src = url;
                    }, 'image/jpeg', 0.9);
                }, 300);

            }).catch(function(err) {
                result.innerHTML = '<div class="status fail">‚ùå Camera error: ' + err.message + '</div>';
                log('Direct camera error: ' + err.message);
            });
        }

        function stopDirectScan() {
            if (directInterval) {
                clearInterval(directInterval);
                directInterval = null;
            }
            if (directStream) {
                directStream.getTracks().forEach(function(t) { t.stop(); });
                directStream = null;
            }
            log('Direct scan stopped');
        }

        // ============================
        // 4. Photo Upload Scan
        // ============================
        function scanPhoto(event) {
            var file = event.target.files[0];
            if (!file) return;

            var result = document.getElementById('photo-result');
            result.innerHTML = '<div class="status info">Scanning photo...</div>';
            log('Photo: ' + file.name + ' (' + Math.round(file.size / 1024) + ' KB)');

            document.getElementById('photo-img').src = URL.createObjectURL(file);
            document.getElementById('photo-preview').style.display = 'block';

            lastPhotoImage = new Image();
            lastPhotoImage.onload = function() {
                var img = lastPhotoImage;
                log('Photo size: ' + img.width + 'x' + img.height);

                var methods = [];
                var currentMethod = 0;

                // Method 1: html5-qrcode scanFile
                methods.push(function(next) {
                    log('Try: html5-qrcode scanFile...');
                    var tempDiv = document.getElementById('h5qr-temp');
                    if (!tempDiv) {
                        tempDiv = document.createElement('div');
                        tempDiv.id = 'h5qr-temp';
                        tempDiv.style.display = 'none';
                        document.body.appendChild(tempDiv);
                    }
                    var scanner = new Html5Qrcode("h5qr-temp");
                    scanner.scanFile(file, false)
                        .then(function(text) {
                            showPhotoResult(text, 'html5-qrcode');
                        })
                        .catch(function(err) {
                            log('html5-qrcode failed: ' + err);
                            next();
                        });
                });

                // Method 2: ZXing full image
                methods.push(function(next) {
                    if (!zxingReader) { next(); return; }
                    log('Try: ZXing full image...');
                    zxingReader.decodeFromImage(img)
                        .then(function(res) {
                            showPhotoResult(res.getText(), 'ZXing');
                        })
                        .catch(function(err) {
                            log('ZXing failed: ' + err);
                            next();
                        });
                });

                // Method 3: ZXing with B&W enhancement
                methods.push(function(next) {
                    if (!zxingReader) { next(); return; }
                    log('Try: ZXing B&W enhanced...');
                    var canvas = document.getElementById('work-canvas');
                    var ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    try {
                        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        var data = imageData.data;
                        for (var i = 0; i < data.length; i += 4) {
                            var gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                            data[i] = data[i + 1] = data[i + 2] = gray > 100 ? 255 : 0;
                        }
                        ctx.putImageData(imageData, 0, 0);

                        canvas.toBlob(function(blob) {
                            if (!blob) { next(); return; }
                            var url = URL.createObjectURL(blob);
                            var bwImg = new Image();
                            bwImg.onload = function() {
                                zxingReader.decodeFromImage(bwImg)
                                    .then(function(res) {
                                        showPhotoResult(res.getText(), 'ZXing B&W');
                                    })
                                    .catch(function() {
                                        log('B&W failed');
                                        URL.revokeObjectURL(url);
                                        next();
                                    });
                            };
                            bwImg.src = url;
                        }, 'image/png');
                    } catch(e) {
                        log('B&W error: ' + e);
                        next();
                    }
                });

                // Method 4: Scan 12 regions
                methods.push(function(next) {
                    log('Try: Scanning regions...');
                    scanPhotoRegions(img, function(found, barcode) {
                        if (found) {
                            showPhotoResult(barcode, 'region scan');
                        } else {
                            log('All methods exhausted');
                            result.innerHTML = '<div class="status fail">‚ùå Could not detect barcode.<br><br>' +
                                '<strong>Tips:</strong><br>' +
                                '‚Ä¢ Take photo VERY close to barcode only<br>' +
                                '‚Ä¢ Good lighting, no shadows<br>' +
                                '‚Ä¢ Barcode should be sharp, not blurry<br>' +
                                '‚Ä¢ Try the Camera Scanner (Test 2) instead</div>';
                        }
                    });
                });

                // Run methods in sequence
                function runNext() {
                    if (currentMethod >= methods.length) return;
                    methods[currentMethod](function() {
                        currentMethod++;
                        runNext();
                    });
                }
                runNext();
            };
            lastPhotoImage.src = URL.createObjectURL(file);
        }

        function showPhotoResult(barcode, method) {
            var result = document.getElementById('photo-result');
            log('*** PHOTO FOUND by ' + method + ': ' + barcode + ' ***');
            result.innerHTML = '<div class="status ok big-result">‚úÖ ' + barcode + '</div>' +
                '<small>Found by: ' + method + '</small><br>' +
                '<a href="/result/' + barcode + '" style="font-size:18px; color:blue;">View Product ‚Üí</a>';
            playBeep();
        }

        function scanPhotoRegions(img, callback) {
            if (!zxingReader) { callback(false, null); return; }

            var canvas = document.getElementById('work-canvas');
            var ctx = canvas.getContext('2d');

            var regions = [
                { x: 0, y: 0.5, w: 1.0, h: 0.5 },
                { x: 0, y: 0.65, w: 1.0, h: 0.35 },
                { x: 0, y: 0, w: 1.0, h: 0.5 },
                { x: 0.1, y: 0.2, w: 0.8, h: 0.6 },
                { x: 0.1, y: 0.4, w: 0.8, h: 0.5 },
                { x: 0, y: 0, w: 0.5, h: 1.0 },
                { x: 0.5, y: 0, w: 0.5, h: 1.0 },
                { x: 0, y: 0.5, w: 0.5, h: 0.5 },
                { x: 0.5, y: 0.5, w: 0.5, h: 0.5 },
                { x: 0, y: 0.3, w: 1.0, h: 0.4 },
                { x: 0.05, y: 0.25, w: 0.9, h: 0.5 },
                { x: 0, y: 0.6, w: 1.0, h: 0.3 }
            ];

            var idx = 0;

            function tryNext() {
                if (idx >= regions.length) {
                    callback(false, null);
                    return;
                }

                var r = regions[idx];
                var sx = Math.floor(img.width * r.x);
                var sy = Math.floor(img.height * r.y);
                var sw = Math.floor(img.width * r.w);
                var sh = Math.floor(img.height * r.h);

                canvas.width = sw;
                canvas.height = sh;
                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

                try {
                    var imageData = ctx.getImageData(0, 0, sw, sh);
                    var data = imageData.data;
                    for (var i = 0; i < data.length; i += 4) {
                        var gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                        data[i] = data[i + 1] = data[i + 2] = gray > 110 ? 255 : 0;
                    }
                    ctx.putImageData(imageData, 0, 0);
                } catch(e) {}

                canvas.toBlob(function(blob) {
                    if (!blob) { idx++; tryNext(); return; }
                    var url = URL.createObjectURL(blob);
                    var rImg = new Image();
                    rImg.onload = function() {
                        zxingReader.decodeFromImage(rImg)
                            .then(function(res) {
                                URL.revokeObjectURL(url);
                                callback(true, res.getText());
                            })
                            .catch(function() {
                                URL.revokeObjectURL(url);
                                idx++;
                                tryNext();
                            });
                    };
                    rImg.src = url;
                }, 'image/png');
            }

            tryNext();
        }

        function playBeep() {
            try {
                var ac = new (window.AudioContext || window.webkitAudioContext)();
                var o = ac.createOscillator();
                var g = ac.createGain();
                o.connect(g); g.connect(ac.destination);
                o.frequency.value = 800; g.gain.value = 0.3;
                o.start(); setTimeout(function() { o.stop(); }, 200);
            } catch(e) {}
        }

        window.addEventListener('beforeunload', function() {
            stopHtml5QrScan();
            stopDirectScan();
        });
    </script>
</body>
</html>